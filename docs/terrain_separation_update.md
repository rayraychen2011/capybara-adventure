# 地形分離更新：NPC 與野生動物地域劃分

## 📋 問題描述

之前的系統中，NPC 和野生動物可能會在相同的地形區域生成，特別是：

- NPC 會在草原（地形代碼 0）生成
- 野生動物主要在森林（地形代碼 1）和湖泊（地形代碼 2）生成
- 缺乏明確的地域劃分

## 🎯 解決方案

### 1. 修改 NPC 管理器 (`src/systems/npc/npc_manager.py`)

**新增草原避開邏輯**：

- NPC 不能在草原（地形代碼 0）生成
- 優先在住宅區（地形代碼 5）和商業區（地形代碼 6）生成
- 後備選項為道路（地形代碼 3）
- 改進了安全位置檢測算法，減少警告訊息

**關鍵修改**：

```python
def _find_safe_spawn_position(self, town_bounds, max_attempts=100):
    # 優先地形類型：住宅區和商業區
    preferred_terrain_codes = [5, 6]  # 住宅區、商業區
    fallback_terrain_codes = [3]      # 道路

    # 避開草原（地形代碼 0）
```

### 2. 更新野生動物管理器 (`src/systems/wildlife/wildlife_manager.py`)

**新增草原動物支援**：

- 新增 `grassland` 棲息地類型
- 兔子和羊群現在主要在草原覓食
- 森林動物（山獅、黑豹、熊）留在森林
- 水生動物（烏龜）留在湖泊

**動物分佈**：

```python
# 草原動物（地形代碼 0）
grassland_species = [
    AnimalType.RABBIT,  # 兔子喜歡草原
    AnimalType.SHEEP,   # 羊群在草原覓食
]

# 森林動物（地形代碼 1）
forest_species = [
    AnimalType.MOUNTAIN_LION,  # 山獅
    AnimalType.BLACK_PANTHER,  # 黑豹
    AnimalType.BEAR,          # 熊
]
```

### 3. 修改碰撞防止系統 (`src/systems/anti_overlap_system.py`)

**更新安全地形定義**：

- 移除草原（地形代碼 0）從 NPC 安全區域
- NPC 安全區域：道路（3）、住宅區（5）、商業區（6）
- 新增地形類型檢查到位置安全驗證

**修改前後對比**：

```python
# 修改前
self.safe_terrain_types = [0, 3]  # 草地和道路

# 修改後
self.safe_terrain_types = [3, 5, 6]  # 道路、住宅區、商業區
```

## 🏆 達成效果

### ✅ 地域明確劃分

**草原區域（地形代碼 0）**：

- 🐰 兔子和羊群的主要活動區域
- ❌ NPC 不會在此生成
- 🌱 野生動物的自然棲息地

**住宅區/商業區（地形代碼 5/6）**：

- 👥 NPC 的主要生活區域
- 🏠 接近建築物和設施
- ❌ 野生動物不會入侵

**森林區域（地形代碼 1）**：

- 🐻 大型肉食動物（熊、山獅、黑豹）
- 🌲 危險野生動物的領域
- ❌ NPC 避免進入

**水域（地形代碼 2）**：

- 🐢 水生動物（烏龜）專屬
- 🎣 釣魚活動區域

### ✅ 系統優化

1. **減少衝突**：NPC 和野生動物不再爭搶相同區域
2. **提升真實性**：符合現實中的動物棲息習性
3. **改善性能**：減少無效的位置生成嘗試
4. **增強體驗**：玩家可以預期在特定地形遇到特定類型的生物

## 🔍 測試驗證

通過自動化測試確認：

```
位置(500, 500) - 草原(代碼0): ❌不安全
位置(1500, 500) - 住宅區(代碼5): ✅安全
位置(2500, 500) - 商業區(代碼6): ✅安全
位置(3500, 500) - 道路(代碼3): ✅安全
```

## 📊 遊戲內驗證

從遊戲日誌可以看到：

```
在地形代碼 0 找到位置: (2940, 2620)
在 grassland (地形代碼:0) 生成 兔子 (總計: 7)

在地形代碼 1 找到位置: (660, 3420)
在 forest (地形代碼:1) 生成 羊 (總計: 1)

在地形代碼 2 找到位置: (2300, 1700)
在 lake (地形代碼:2) 生成 烏龜 (總計: 15)
```

## 🎮 對玩家的影響

1. **探索策略**：玩家需要根據地形類型規劃狩獵路線
2. **安全考量**：草原相對安全，森林有危險動物
3. **資源管理**：不同地形提供不同類型的資源和機會
4. **沉浸體驗**：更加真實的生態系統模擬

這次更新成功實現了「NPC 不能到草原上，野生動物都在草原上」的需求，同時保持了系統的穩定性和效能。
